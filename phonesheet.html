<!doctype html>
<html>
<head>
<link rel='stylesheet' href='phonesheet.css' type='text/css' media='screen'/>
<meta charset="UTF-8">
<meta name='viewport' content="width=device-width, initial-scale=1" />

<script>
var gGroups = null;
var gTrip = null;
var gTotal = null;
var gTemplate = null;
var gCurrency = null;

var gSummaryWhat = "";
var gSummaryAmount = "";
var gSummaryCurrencyUsed = "";
var gSummaryPaidBy = "";
var gSummaryGuests = [];

function ParseJSON(value)
{
  try {
    var parsed = JSON.parse(value);
    if (parsed && typeof parsed === "object") {
      return parsed;
    }
  }
  catch (e) { }
  return "";
}

function EmailBody(what, amount, currencyUsed, paygroup, groupshares)
{
    var body = {};
    var result = gTemplate.slice();
    result[0] = what + " (" + currencyUsed + ")";
    result[1] = amount;
    if (paygroup >= 0) {
	result[gGroups[paygroup].index[1]] = gTotal;
    }
    for (var i=0; i<gGroups.length; i++) {
	if (groupshares[i] > 0) {
	    result[gGroups[i].index[0]] = groupshares[i];
	}
    }

    body["paidby"] = (paygroup >= 0);
    body["result"] = result;
    return body;
}

function PaygroupFromPayer(paidby)
{
    if (!paidby) {
	return -1;
    }

    paidby = paidby.toLowerCase();
    for (var i=0; i<gGroups.length; i++) {
	for (var j in gGroups[i].who) {
	    if (paidby == j.toLowerCase()) {
		return i;
	    }
	}
	for (var j=0; j<gGroups[i].email.length; j++) {
	    if (paidby == gGroups[i].email[j].toLowerCase()) {
		return i;
	    }
	}
    }

    return -1;
}

function SharesFromGuests(guestlist)
{
    var groupshares = [];
    for (var i=0; i<gGroups.length; i++) {
	var sum = 0.0;
	for (var j in gGroups[i].who) {
	    var who = j.toLowerCase();
	    if (guestlist.has(who)) {
		sum += parseFloat(gGroups[i].who[j]);
	    }
	}
	groupshares.push(sum);
    }
    return groupshares;
}

function EmailHTML(what, amount, currencyUsed, paidby, guests)
{
    var paygroup = PaygroupFromPayer(paidby);
    var groupshares = SharesFromGuests(guests);

    var toperson = encodeURI("msr3ckovic@gmail.com");
    var subject = "RACUN " + gTrip;
    var body = EmailBody(what, amount, currencyUsed,
			 paygroup, groupshares);

    var total = "<a target=\"_blank\" href=\"mailto:" + toperson;
    total += "?subject=" + subject;
    total += "&amp;body=" + encodeURIComponent(JSON.stringify(body));
    total += "\">Submit</a>";
    return total;
}

function CallbackWhat(cntrl)
{
    if (true || IsThereEnoughInput()) {
	var el = document.getElementById("done");
	el.setAttribute('style', 'display:block');
    }
}

function CallbackAmount(cntrl)
{
    if (true || IsThereEnoughInput()) {
	var el = document.getElementById("done");
	el.setAttribute('style', 'display:block');
    }
}

function CallbackPaidBy(cntrl)
{
    if (true || IsThereEnoughInput()) {
	var el = document.getElementById("done");
	el.setAttribute('style', 'display:block');
    }
}

function BuildControlsGuests()
{
    var perrow = 2;
    var percell = 2;
    var total = "<table width=\"100%\">";
    total += "<tr><td class=\"rightjustified\">Who was all there?</td><td>&nbsp;</td></tr>";

    var cells = 0;
    var items = 0;

    for (var i=0; i<gGroups.length; i++) {
	var who = gGroups[i].who;
	var whosize = 0;
	for (var j in who) {
	    whosize ++;
	}

	items = 0;
	for (var j in who) {
	    if (items == 0) {
		if (cells % perrow == 0) {
		    total += "<tr>";
		}
		if (cells % perrow == 0) {
		    total += "<td class=\"rightjustified\">";
		} else {
		    total += "<td>";
		}
	    } else if (whosize > 3 && items % percell == 0) {
		if (cells % perrow == 0) {
		    total += "<td class=\"rightjustified\">";
		} else {
		    total += "<td>";
		}
	    }
	    total += "<input checked type=\"checkbox\" value=\"" + j + "," + who[j] + "\">" + j + "</input>";
	    items ++;

	    if (whosize > 3 && items % percell == 0) {
		total += "</td>";
		cells ++;
	    }
	}
	if (whosize < 4 || items % percell > 0) {
	    total += "</td>";
	    cells ++;
	}
	if (cells % perrow == 0) {
	    total += "</tr>";
	}
    }

    total += "</table>";
    return total;
}

function BuildControlsWhat()
{
    var total = "";
    total += "<table width=\"100%\">";
    total += "<tr>";
    total += "<td class=\"rightjustified\" width=\"50%\">Where were we?</td>";
    total += "<td>";

    total += "<input type=\"text\" size=\"100%\"onchange=\"CallbackWhat(this)\" id=\"famount\">";
    total += "</input>";
    total += "</td></tr></table>";
    return total;
}

function BuildControlsAmount()
{
    var total = "";
    total += "<table width=\"100%\">";
    total += "<tr>";
    total += "<td class=\"rightjustified\" width=\"50%\">How much did we pay?</td>";
    total += "<td>";

    total += "<input type=\"number\" onchange=\"CallbackAmount(this)\" id=\"famount\">";
    total += "</input>";

    total += "<select onchange=\"CallbackCurrency(this)\" id=\"fcurrency\">";
    for (var i in gCurrency) {
	if (gCurrency[i] == 1) {
	    total += "<option selected value=\"" + i + "," + gCurrency[i] + "\">" + i + "</option>";
	} else {
	    total += "<option value=\"" + i + "," + gCurrency[i] + "\">" + i + "</option>";
	}
    }
    total += "</select>";
    total += "</td></tr></table>";
    return total;
}

function BuildControlsPaidBy()
{
    var total = "";
    total += "<table width=\"100%\">";
    total += "<tr>";
    total += "<td class=\"rightjustified\" width=\"50%\">Who paid?</td>";
    total += "<td>";

    total += "<select onchange=\"CallbackPaidBy(this)\" id=\"fpaidby\">";
    total += "<option value=\"\" selected=\"selected\">I did</option>";
    for (var i=0; i<gGroups.length; i++) {
	var who = gGroups[i].who;
	for (var j in who) {
	    if (who[j] >= 1) {
		total += "<option value=\"" + j.toLowerCase() + "\">" + j + "</option>";
	    }
	}
    }
    total += "</select>";
    total += "</td></tr></table>";
    return total;
}

function BuildControls()
{
    document.getElementById("trip").innerHTML = gTrip;

    document.getElementById("what").innerHTML = BuildControlsWhat();
    document.getElementById("amount").innerHTML = BuildControlsAmount();
    document.getElementById("guests").innerHTML = BuildControlsGuests();
    document.getElementById("paidby").innerHTML = BuildControlsPaidBy();
}

function BuildSummary()
{
    return "SUMMARY";
}

function BuildEmail()
{
    var what = "Reka";
    var amount = 324.23;
    var currencyUsed = "Euro";
    var paidby = "Milan";
    var guests = new Set(["norma", "peter", "sasha", "milan", "ceca", "ryan", "sholto", "vanja", "bojan", "nikki", "zuzana"]);

    return EmailHTML(what, amount, currencyUsed, paidby, guests);
}

function IsThereEnoughInput()
{
    return gSummaryWhat && gSummaryAmount && gSummaryPaidBy && gSummaryGuests.length > 0;
}

function DoDone()
{
    var el;
    BuildSummary();

    el = document.getElementById("done");
    el.setAttribute('style', 'display:none');

    el = document.getElementById("controls");
    el.setAttribute('style', 'display:none');

    el = document.getElementById("summary");
    el.innerHTML = BuildSummary();
    el.setAttribute('style', 'display:block');

    el = document.getElementById("submit");
    el.innerHTML = BuildEmail();
    el.setAttribute('style', 'display:block');

    el = document.getElementById("reset");
    el.setAttribute('style', 'display:block');
}

function DoReset()
{
    var el;

    el = document.getElementById("submit");
    el.setAttribute('style', 'display:none');

    el = document.getElementById("reset");
    el.setAttribute('reset', 'display:none');

    el = document.getElementById("controls");
    el.setAttribute('style', 'display:block');

    el = document.getElementById("summary");
    el.setAttribute('style', 'display:none');

    el = document.getElementById("done");
    el.setAttribute('style', 'display:block');
}

function ScriptCallback(jsonIn)
{
    // Need the gsx$body for template and currency and total, and
    // need the gsx$what for groups
    var entries = jsonIn.feed.entry;
    var body = ParseJSON(entries[0].gsx$body.$t);
    gTrip = body.trip;
    gTotal = body.total;
    gTemplate = body.template;
    gCurrency = body.currency;
    
    var what = ParseJSON(entries[0].gsx$what.$t);
    gGroups = what.groups;

    BuildControls();
}
</script>
</head>

<body>
<center>
<div id="racun">рачун</div>
<div id="trip"></div>
<div id="controls">
 <div id="what"></div>
 <div id="amount"></div>
 <div id="guests"></div>
 <div id="paidby"></div>
</div>
<div id="summary">
</div>

<div id="done" style="display:none">
 <button onclick="DoDone()" class="btn btnDone">Review</button>
</div>
<div id="submit" style="display:none"></div>
<div id="reset" style="display:none">
 <button onclick="DoReset()" class="btn btnReset">Go Back</button>
</div>
</div>

</div>
</center>

<script src="https://spreadsheets.google.com/feeds/list/1oWmF6mKi126JJFoBIG2_XH7zV8I7LxzeP5MfyMhrT_4/1/public/values?alt=json-in-script&callback=ScriptCallback"></script>

</body>
</html>
